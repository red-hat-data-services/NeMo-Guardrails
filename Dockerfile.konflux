###############################################################
# Stage 1 Base builder image with common tooling
###############################################################
FROM registry.access.redhat.com/ubi9/python-312@sha256:34263471b5e86b0704054e817d7703d0063b0909a64bd95360f4a8b0c730d970 as packages-build

USER root
WORKDIR /app

ENV PATH="$HOME/.cargo/bin:$PATH"
ENV PKG_CONFIG_PATH=/usr/local/lib/pkgconfig/
ARG TARGETARCH

# Install dependencies
RUN if [ "$TARGETARCH" = "ppc64le" ]; then                        \
        dnf install -y \
        make libtool wget patch ninja-build cmake xz bzip2-devel libffi-devel zlib-devel openssl-devel libevent-devel \
        python3.12 python3.12-devel python3.12-pip clang \
        gcc-toolset-14-gcc gcc-toolset-14-gcc-c++ gcc-toolset-14-gcc-gfortran skopeo rust cargo && \
        dnf clean all                                                   && \
        pip install --upgrade setuptools-rust pip 'cmake<4' setuptools wheel ; \
    fi

COPY requirements* /app/

# Create a dummy file to trigger build dependency
RUN touch /tmp/control

###############################################################
# Stage 2 to build OpenBLAS
###############################################################

FROM packages-build AS openblas-builder
ENV OPENBLAS_VERSION=0.3.30
ARG TARGETARCH

WORKDIR /app

# Creating a directory for OpenBlas
RUN mkdir /tmp/openblas

RUN if [ "$TARGETARCH" = "ppc64le" ]; then \
        source /opt/rh/gcc-toolset-14/enable &&  \
        wget https://github.com/OpenMathLib/OpenBLAS/releases/download/v${OPENBLAS_VERSION}/OpenBLAS-${OPENBLAS_VERSION}.zip && \
        unzip OpenBLAS-${OPENBLAS_VERSION}.zip -d /tmp/ && mv -T /tmp/OpenBLAS-${OPENBLAS_VERSION} /tmp/openblas             && \
        cd /tmp/openblas                                                                                                     && \
        make -j$(nproc) TARGET=POWER9 BINARY=64 USE_OPENMP=1 USE_THREAD=1 NUM_THREADS=120 DYNAMIC_ARCH=1 INTERFACE64=0        ; \
    fi

###############################################################
# Stage 3 to build pyTorch
###############################################################

FROM packages-build AS torch-builder
USER root

WORKDIR /app

ARG MAX_JOBS
ARG _GLIBCXX_USE_CXX11_ABI=1
ARG TARGETARCH

RUN mkdir -p /torchwheels

RUN if [ "$TARGETARCH" = "ppc64le" ]; then \
    export TORCH_VERSION=$(sed -n "s/^torch==//p" /app/requirements-torch.in)                                                      && \
    source /opt/rh/gcc-toolset-14/enable &&  \
    git clone --recursive https://github.com/pytorch/pytorch.git -b v${TORCH_VERSION} && \
    cd pytorch && pip install -r requirements.txt && \
    rm -f dist/torch*+git*whl                     && \
    # Set MAX_JOBS to 2 or 4 to prevent OOM
    # MAX_JOBS=4 \
    USE_NCCL=0 \
    BUILD_TEST=0 \
    PYTORCH_BUILD_VERSION=${TORCH_VERSION} \
    PYTORCH_BUILD_NUMBER=1 \
    pip wheel . --no-build-isolation --wheel-dir /torchwheels/ \
; fi

###############################################################
# Stage 4 to build Tiktoken
###############################################################

FROM packages-build as tiktoken-builder
ARG TARGETARCH
WORKDIR /app

RUN mkdir -p /tiktokenwheels

RUN if [ "$TARGETARCH" = "ppc64le" ]; then \
        export TIKTOKEN_VERSION=$(sed -n "s/^tiktoken==//p" /app/requirements.txt) && \
        source /opt/rh/gcc-toolset-14/enable && \
        git clone https://github.com/openai/tiktoken.git && \
        cd tiktoken && \
        git checkout ${TIKTOKEN_VERSION} && \
        pip wheel . --wheel-dir /tiktokenwheels ; \
    fi

###############################################################
# Stage 5 to build onnxruntime
###############################################################
FROM packages-build AS onnxruntime-builder
ARG TARGETARCH
USER root

WORKDIR /app

ENV LD_LIBRARY_PATH=/usr/local/lib64:/usr/local/lib:/usr/lib64:/usr/lib:/app/.openblas/lib

# copy built OpenBLAS sources
COPY --from=openblas-builder /tmp/openblas/ /build/openblas

# Install OpenBLAS
RUN if [ "$TARGETARCH" = "ppc64le" ]; then \
        PREFIX=/app/.openblas make -C /build/openblas install   && \
        ln -sf /app/.openblas/lib/libopenblasp-r0.3.30.so /app/.openblas/lib/libopenblasp.so.0 ; \
   fi

COPY scripts/build_onnxruntime.sh /build/build_onnxruntime.sh

RUN mkdir -p /onnxruntime_wheels

# Build onnxruntime
RUN if [ "$TARGETARCH" = "ppc64le" ]; then \
        export ONNXRUNTIME_VERSION=$(sed -n "s/^onnxruntime==//p" /app/requirements.txt) && \
        sh /build/build_onnxruntime.sh      ; \
    fi

###############################################################
# Stage 6 Install all the dependencies
###############################################################

FROM registry.access.redhat.com/ubi9/python-312@sha256:34263471b5e86b0704054e817d7703d0063b0909a64bd95360f4a8b0c730d970 as build

USER 0
WORKDIR /app

ARG TARGETARCH
ARG GUARDRAILS_PROFILE=opensource
ENV LD_LIBRARY_PATH=/usr/local/lib64:/usr/local/lib:/usr/lib64:/usr/lib:/app/.openblas/lib
ENV PKG_CONFIG_PATH=/usr/local/lib/pkgconfig/:/app/.openblas/lib/pkgconfig
ENV PATH="$HOME/.cargo/bin:$PATH"
ENV BLIS_ARCH=generic

COPY requirements.txt requirements-torch.txt pyproject.toml README.md ./
COPY nemoguardrails/ ./nemoguardrails/
COPY scripts/ ./scripts/
COPY examples/bots/ ./examples/bots/

RUN chmod +x ./scripts/entrypoint.sh

RUN python3 -m pip install --no-cache-dir pyyaml

RUN python3 ./scripts/filter_guardrails.py ./scripts/provider-list.yaml $GUARDRAILS_PROFILE

ENV HF_HOME=/app/.cache/huggingface \
    TRANSFORMERS_CACHE=/app/.cache/transformers \
    SENTENCE_TRANSFORMERS_HOME=/app/.cache/sentence_transformers \
    NLTK_DATA=/app/.cache/nltk_data \
    FASTEMBED_CACHE_PATH=/app/.cache/fastembed

RUN python3 -m venv /app/.venv

# Copy OpenBLAS
COPY --from=openblas-builder /tmp/openblas/ /tmp/openblas

# Dummy file to trigger build dependency
COPY --from=torch-builder /tmp/control /dev/null
COPY --from=tiktoken-builder /tmp/control /dev/null
COPY --from=onnxruntime-builder /tmp/control /dev/null

RUN --mount=type=cache,from=torch-builder,source=/torchwheels/,target=/tmp/torchwheels/,ro \
    --mount=type=cache,from=tiktoken-builder,source=/tiktokenwheels/,target=/tmp/tiktokenwheels/,ro \
    --mount=type=cache,from=onnxruntime-builder,source=/onnxruntime_wheels/,target=/tmp/onnxruntime_wheels/,ro \
    if [ "$TARGETARCH" = "ppc64le" ]; then \
        /app/.venv/bin/pip install \
            /tmp/torchwheels/*.whl \
            /tmp/tiktokenwheels/*.whl \
            /tmp/onnxruntime_wheels/*.whl && \
        PREFIX=/app/.openblas make -C /tmp/openblas install && rm -rf /tmp/openblas     ; \
    fi

RUN /app/.venv/bin/pip install --no-cache-dir -r requirements.txt && \
    /app/.venv/bin/pip install --no-cache-dir --no-deps . && \
    rm -rf /root/.cache/pip /tmp/* /var/tmp/*

RUN /app/.venv/bin/pip install --no-cache-dir /cachi2/output/deps/generic/en_core_web_lg-3.8.0-py3-none-any.whl

RUN if [ "$TARGETARCH" != "ppc64le" ]; then     \
        /app/.venv/bin/pip install --no-cache-dir -r requirements-torch.txt ; \
    fi

RUN set -ex && \
    GUARDRAILS_PROFILE=$GUARDRAILS_PROFILE /app/.venv/bin/python ./scripts/pre_download_required_models.py && \
    find /app/.cache -type f -name "*.pyc" -delete && \
    find /app/.cache -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true && \
    find /app/.cache -type d -name ".git" -exec rm -rf {} + 2>/dev/null || true && \
    rm -rf /app/.cache/huggingface/xet /root/.cache /tmp/* /var/tmp/*

###############################################################
# Stage 7 Final Build
###############################################################

FROM registry.access.redhat.com/ubi9/python-312:latest as runtime

USER 0
WORKDIR /app

ENV LD_LIBRARY_PATH=/usr/local/lib64:/usr/local/lib:/usr/lib64:/usr/lib:/app/.openblas/lib

COPY --from=build /app /app

RUN rm -f /etc/security/namespace.conf /usr/lib64/security/pam_namespace.so || true && \
    chgrp -R 0 /app && \
    chmod -R g=u /app && \
    chmod +x /app/scripts/entrypoint.sh

USER 1001

ENV HF_HOME=/app/.cache/huggingface \
    TRANSFORMERS_CACHE=/app/.cache/transformers \
    SENTENCE_TRANSFORMERS_HOME=/app/.cache/sentence_transformers \
    NLTK_DATA=/app/.cache/nltk_data \
    FASTEMBED_CACHE_PATH=/app/.cache/fastembed \
    PATH="/app/.venv/bin:$PATH" \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1

EXPOSE 8000
ENTRYPOINT ["./scripts/entrypoint.sh"]

LABEL com.redhat.component="odh-nemo-guardrails" \
      name="rhoai/odh-nemo-guardrails-rhel9" \
      description="NeMo Guardrails is an open-source toolkit for easily adding programmable guardrails to LLM-based conversational systems" \
      summary="odh-nemo-guardrails" \
      maintainer="['managed-open-data-hub@redhat.com']" \
      io.openshift.expose-services="8000:http" \
      io.k8s.display-name="odh-nemo-guardrails" \
      io.k8s.description="NeMo Guardrails toolkit for controlling and securing LLM-based conversational systems" \
      com.redhat.license_terms="https://www.redhat.com/licenses/Red_Hat_Standard_EULA_20191108.pdf"
